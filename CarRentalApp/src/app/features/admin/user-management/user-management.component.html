<div [class]="styles.opsCenter">
  <div class="container-fluid mx-auto px-4 lg:px-8">
    <p-toast></p-toast>

    <div class="flex flex-column md:flex-row md:align-items-end justify-content-between mb-6 gap-4">
      <div class="fadeinleft animation-duration-800">
        <h1 [class]="theme.typography.sectionHeading" class="mb-2">
          User <span [class]="theme.ui.gradientText">Registry</span>
        </h1>
        <p [class]="theme.typography.sectionSubheading" class="font-medium m-0">
          Manage NEX membership and deployment authorizations.
        </p>
      </div>
      <div class="fadeinright animation-duration-800">
        <p-button
          label="Register New User"
          icon="pi pi-user-plus"
          (click)="openNew()"
          styleClass="p-button-primary mbux-add-asset-btn"
        ></p-button>
      </div>
    </div>

    <div [class]="styles.tableContainer">
      <p-table
        [value]="users"
        [rows]="10"
        [paginator]="true"
        [paginator]="true"
        styleClass="mbux-table"
      >
        <ng-template pTemplate="header">
          <tr>
            <th [class]="styles.tableHeader">Identity</th>
            <th [class]="styles.tableHeader">Username</th>
            <th [class]="styles.tableHeader">Email</th>
            <th [class]="styles.tableHeader" class="text-center">Role</th>
            <th [class]="styles.tableHeader">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
          <tr class="asset-row">
            <td>
              <div class="flex flex-column">
                <span class="text-white font-bold">{{ user.firstName }} {{ user.lastName }}</span>
                <span class="text-secondary text-xs uppercase tracking-widest">ID: #0{{ user.id }}</span>
              </div>
            </td>
            <td>
              <span class="text-secondary">{{ user.username }}</span>
            </td>
            <td>
              <span class="text-secondary">{{ user.email }}</span>
            </td>
            <td class="text-center">
              <p-tag
                [value]="user.role"
                [severity]="user.role === 'admin' ? 'info' : 'secondary'"
                [value]="user.role"
                [severity]="user.role === 'admin' ? 'info' : 'secondary'"
                [ngClass]="{'status-glow': true}"
              ></p-tag>
            </td>
            <td>
              <div class="flex gap-2">
                <p-button
                  icon="pi pi-calendar"
                  [text]="true"
                  styleClass="action-view"
                  pTooltip="View Missions"
                  (click)="viewBookings(user)"
                ></p-button>
                @if (user.id !== 1) {
                  <p-button
                    icon="pi pi-trash"
                    [text]="true"
                    styleClass="action-delete"
                    pTooltip="Revoke Access"
                    (click)="deleteUser(user)"
                  ></p-button>
                }
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Registration Dialog -->
  <app-nex-dialog
    [(visible)]="userDialog"
    header="Member Registration"
    width="500px"
    (onHide)="hideDialog()"
  >
    <div body>
      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="mbux-dialog-form flex flex-column gap-4">
        <div class="grid">
            <div class="col-12 md:col-6">
                <app-nex-form-field label="First Name" [control]="userForm.get('firstName')">
                    <input type="text" pInputText formControlName="firstName" class="mbux-input w-full" placeholder="John" />
                </app-nex-form-field>
            </div>
            <div class="col-12 md:col-6">
                <app-nex-form-field label="Last Name" [control]="userForm.get('lastName')">
                    <input type="text" pInputText formControlName="lastName" class="mbux-input w-full" placeholder="Doe" />
                </app-nex-form-field>
            </div>
        </div>

        <app-nex-form-field label="Username" [control]="userForm.get('username')">
          <input type="text" pInputText formControlName="username" class="mbux-input" placeholder="johndoe" />
        </app-nex-form-field>

        <app-nex-form-field label="Email" [control]="userForm.get('email')">
          <input type="email" pInputText formControlName="email" class="mbux-input" placeholder="john@example.com" />
        </app-nex-form-field>

        <app-nex-form-field label="Security Protocol (Password)" [control]="userForm.get('password')">
          <p-password 
            formControlName="password" 
            [toggleMask]="true" 
            [feedback]="false"
            styleClass="w-full"
            inputStyleClass="mbux-input"
            placeholder="••••••••"
          ></p-password>
        </app-nex-form-field>

        <div class="flex flex-column gap-2">
          <label class="mbux-field-label">Access Level</label>
          <p-select [options]="roles" formControlName="role" styleClass="mbux-select w-full" optionLabel="label" optionValue="value" appendTo="body"></p-select>
        </div>
      </form>
    </div>

    <div footer>
      <div class="mbux-dialog-footer">
        <p-button label="Cancel" icon="pi pi-times" (click)="hideDialog()" styleClass="mbux-btn-cancel"></p-button>
        <p-button label="Authorize Member" icon="pi pi-check" (click)='saveUser()' styleClass="mbux-btn-save ml-2"></p-button>
      </div>
    </div>
  </app-nex-dialog>

  <!-- Missions Dialog -->
  <app-nex-dialog
    [(visible)]="bookingsDialog"
    [header]="'Deployment History: ' + selectedUser?.firstName"
    width="700px"
    (onHide)="bookingsDialog = false"
  >
    <div body class="p-2">
        <p-table [value]="selectedUserBookings" styleClass="mbux-table">
            <ng-template pTemplate="header">
                <tr>
                    <th>Vehicle</th>
                    <th>Window</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-booking>
                <tr>
                    <td>{{ booking.car?.brand }} {{ booking.car?.model }}</td>
                    <td>{{ booking.startDate | date:'MMM d' }} - {{ booking.endDate | date:'MMM d, y' }}</td>
                    <td>
                        <p-tag [value]="booking.status" [severity]="getBookingSeverity(booking.status)" [ngClass]="{'status-glow': true}"></p-tag>
                    </td>
                    <td>
                        <p-button
                            icon="pi pi-trash"
                            [text]="true"
                            styleClass="action-delete"
                            (click)="deleteReservation(booking.id)"
                            pTooltip="Cancel Deployment"
                        ></p-button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="4" class="text-center p-4 text-secondary italic">No recorded missions for this member.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
  </app-nex-dialog>

  <p-confirmdialog appendTo="body" styleClass="mbux-confirm-dialog"></p-confirmdialog>
</div>
