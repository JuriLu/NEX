<div [class]="styles.opsCenter">
  <div class="container-fluid mx-auto px-4 lg:px-8">
    <p-toast></p-toast>

    <div class="flex flex-column md:flex-row md:align-items-end justify-content-between mb-6 gap-4">
      <div class="fadeinleft animation-duration-800">
        <h1 [class]="theme.typography.sectionHeading" class="mb-2">
          Fleet <span [class]="theme.ui.gradientText">Operations</span>
        </h1>
        <p [class]="theme.typography.sectionSubheading" class="font-medium m-0">
          Synchronize and maintain the NEX vehicle network.
        </p>
      </div>
      <div class="fadeinright animation-duration-800">
        <p-button
          label="Add Asset"
          icon="pi pi-plus"
          (click)="openNew()"
          styleClass="p-button-primary mbux-add-asset-btn"
        ></p-button>
      </div>
    </div>

    <div [class]="styles.tableContainer">
      <p-table
        [value]="cars"
        [rows]="10"
        [paginator]="true"
        responsiveLayout="scroll"
        styleClass="mbux-table"
      >
        <ng-template pTemplate="header">
          <tr>
            <th [class]="styles.tableHeader">Asset</th>
            <th [class]="styles.tableHeader">Model</th>
            <th [class]="styles.tableHeader">Category</th>
            <th [class]="styles.tableHeader" class="text-center">Operational Status</th>
            <th [class]="styles.tableHeader">Command</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-car>
          <tr class="asset-row">
            <td>
              <div [class]="styles.assetPreview">
                <img [src]="car.image" [alt]="car.brand" class="w-full h-full object-contain" />
              </div>
            </td>
            <td>
              <div class="car-brand">{{ car.brand }}</div>
              <div class="car-model">{{ car.model }}</div>
            </td>
            <td>
              <span [class]="theme.typography.label">{{ car.category }}</span>
            </td>
            <td class="text-center">
              <p-tag
                [value]="car.available ? 'Active' : 'Offline'"
                [severity]="car.available ? 'success' : 'danger'"
                styleClass="status-glow"
              ></p-tag>
            </td>
            <td>
              <div class="flex gap-2">
                <p-button
                  icon="pi pi-pencil"
                  [text]="true"
                  styleClass="action-edit"
                  (click)="editCar(car)"
                ></p-button>
                <p-button
                  icon="pi pi-trash"
                  [text]="true"
                  styleClass="action-delete"
                  (click)="deleteCar(car)"
                ></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- MBUX Premium Dialog -->
  <p-dialog
    [(visible)]="carDialog"
    [header]="editingCar ? 'Edit Vehicle' : 'Add New Vehicle'"
    [modal]="true"
    styleClass="mbux-premium-dialog"
    [style]="{ width: '550px' }"
    appendTo="body"
  >
    <ng-template pTemplate="content">
      <form [formGroup]="carForm" class="mbux-dialog-form">
        <div class="field mb-5 mbux-inline-field">
          <label class="mbux-field-label">Brand</label>
          <div class="input-wrapper">
            <input
              type="text"
              pInputText
              formControlName="brand"
              class="mbux-input"
              placeholder="e.g., Mercedes-Benz"
            />
            <div
              class="validation-warning"
              [class.innovative]="carForm.get('brand')?.errors && !carForm.get('brand')?.hasError('required')"
              *ngIf="carForm.get('brand')?.invalid && (carForm.get('brand')?.dirty || carForm.get('brand')?.touched)"
            >
              <i class="pi pi-exclamation-circle"></i>
              <span>{{ carForm.get('brand')?.hasError('required') ? 'Brand is required.' : 'Invalid format (letters only).' }}</span>
            </div>
          </div>
        </div>

        <div class="field mb-5 mbux-inline-field">
          <label class="mbux-field-label">Model</label>
          <div class="input-wrapper">
            <input
              type="text"
              pInputText
              formControlName="model"
              class="mbux-input"
              placeholder="e.g., S-Class"
            />
            <div
              class="validation-warning"
              [class.innovative]="carForm.get('model')?.errors && !carForm.get('model')?.hasError('required')"
              *ngIf="carForm.get('model')?.invalid && (carForm.get('model')?.dirty || carForm.get('model')?.touched)"
            >
              <i class="pi pi-exclamation-circle"></i>
               <span>{{ carForm.get('model')?.hasError('required') ? 'Model is required.' : 'Invalid format (alphanumeric).' }}</span>
            </div>
          </div>
        </div>
        
        <div class="field mb-5 mbux-inline-field">
          <label class="mbux-field-label">Class</label>
          <div class="input-wrapper">
            <p-select
              [options]="categories"
              formControlName="category"
              optionLabel="label"
              optionValue="value"
              styleClass="mbux-select w-full"
              placeholder="Select class"
            ></p-select>
             <div
              class="validation-warning"
              [class.innovative]="carForm.get('category')?.errors && !carForm.get('category')?.hasError('required')"
              *ngIf="carForm.get('category')?.invalid && (carForm.get('category')?.dirty || carForm.get('category')?.touched)"
            >
              <i class="pi pi-exclamation-circle"></i>
              <span>Category is required.</span>
            </div>
          </div>
        </div>

        <div class="field mb-5 mbux-inline-field">
          <label class="mbux-field-label">State</label>
          <div class="input-wrapper">
            <div class="mbux-availability-toggle">
              <span class="availability-status" [class.active]="carForm.get('available')?.value">
                {{ carForm.get('available')?.value ? 'Available' : 'Unavailable' }}
              </span>
              <p-toggleswitch formControlName="available"></p-toggleswitch>
            </div>
          </div>
        </div>

        <div class="field mb-5 mbux-inline-field">
          <label class="mbux-field-label">Pricing</label>
          <div class="input-wrapper">
              <div class="flex gap-3 w-full">
                <div class="flex-grow-1">
                    <p-inputNumber
                    formControlName="pricePerDay"
                    mode="decimal"
                    [minFractionDigits]="2"
                    styleClass="mbux-input-number w-full"
                    placeholder="Price per Day"
                    ></p-inputNumber>
                </div>
                <div class="w-auto" style="min-width: 120px;">
                    <p-select
                    [options]="currencies"
                    formControlName="currency"
                    optionLabel="label"
                    optionValue="value"
                    styleClass="mbux-select w-full"
                    ></p-select>
                </div>
              </div>
              <div
                class="validation-warning"
                [class.innovative]="carForm.get('pricePerDay')?.errors && !carForm.get('pricePerDay')?.hasError('required')"
                *ngIf="carForm.get('pricePerDay')?.invalid && (carForm.get('pricePerDay')?.dirty || carForm.get('pricePerDay')?.touched)"
            >
                <i class="pi pi-exclamation-circle"></i>
                <span>{{ carForm.get('pricePerDay')?.hasError('required') ? 'Price is required.' : 'Must be greater than 0.' }}</span>
            </div>
          </div>
        </div>

        <!-- Centered Image Section -->
        <div class="field mbux-image-section">
          <label class="mbux-field-label mb-3">Vehicle Identity (Image)</label>
          <div class="mbux-image-centered-container">
            <div class="mbux-image-uploader-square">
              <div *ngIf="!imagePreview" class="upload-placeholder">
                <div class="mbux-upload-icon mb-3">
                  <i class="pi pi-camera" style="font-size: 2.5rem; color: rgba(139, 92, 246, 0.5);"></i>
                </div>
                <div class="mbux-upload-btn">
                  <p-fileupload
                    mode="basic"
                    chooseLabel="Select Vehicle Image"
                    accept="image/*"
                    (onSelect)="onImageSelect($event)"
                    [auto]="true"
                  ></p-fileupload>
                </div>
                <small class="block mt-3 text-secondary text-center px-4">
                  <i class="pi pi-info-circle mr-1"></i>
                  1920x1080px (HQ) recommended.
                </small>
              </div>
              <div *ngIf="imagePreview" class="preview-container relative w-full h-full">
                <img [src]="imagePreview" class="asset-square-preview" />
                <button
                  pButton
                  icon="pi pi-times"
                  class="p-button-rounded p-button-danger p-button-text absolute top-0 right-0 m-2"
                  (click)="imagePreview = null; carForm.patchValue({ image: null })"
                ></button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </ng-template>

    <ng-template pTemplate="footer">
      <div class="mbux-dialog-footer">
        <p-button
          label="Cancel"
          icon="pi pi-times"
          (click)="hideDialog()"
          styleClass="mbux-btn-cancel"
        ></p-button>
        <p-button
          [label]="editingCar ? 'Update Vehicle' : 'Add Vehicle'"
          icon="pi pi-check"
          (click)="saveCar()"
          styleClass="mbux-btn-save ml-4"
        ></p-button>
      </div>
    </ng-template>
  </p-dialog>

  <p-confirmdialog appendTo="body" styleClass="mbux-confirm-dialog"></p-confirmdialog>
</div>
